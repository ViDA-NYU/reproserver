{% extends "base.html" %}

{% block content %}

<h1>Package <a href="{{ experiment_url }}">{{ run.upload.filename }}</a>, run {{ run.short_id }}</h1>

{% if run.status == "finished" %}

<div class="panel panel-success" id="panel1">
  <div class="panel-heading">
    <h4 class="panel-title">
      <a data-toggle="collapse" data-target="#runlog"
         href="#runlog" class="collapsed">
        Run log
      </a>
    </h4>
  </div>
  <div id="runlog" class="panel-collapse collapse">
    <div class="panel-body">
      <pre>{% for line in log %}{{ line }}
{% endfor %}</pre>
    </div>
  </div>
</div>

<h2>Output files:</h2>

  {% if run.output_files %}

  <ul>

    {% for file in run.output_files %}

    <li><a href="{{ output_link(file) }}">{{ file.name }}</a>, {{ file.size }} bytes</li>

    {% endfor %}

  </ul>

  {% else %}

<p>No output files</p>

  {% endif %}

{% else %}

<div id="preparing" style="display: none;">
  queued
  building
  setting inputs
</div>

<div id="running">
  <p>Run in progress, please wait...</p>

  {% if run.ports %}
  <p>
    Exposed ports:
    {% for port in run.ports %}
    <a href="{{ get_port_url(port.port_number) }}">{{ port.port_number }}</a>
    {% endfor %}
  </p>
  {% endif %}

  <p>Run log:</p>
  <pre id="log">{% for line in log %}{{ line }}
  {% endfor %}</pre>

  <div id="finishing" style="display: none;">
    <strong>storing outputs</strong>
  </div>
</div>

<script>
var log_lines = {{ log | length }};
var preparing = document.getElementById("preparing");
var running = document.getElementById("running");
var finishing = document.getElementById("finishing");
var preparing = document.getElementById("preparing");
var dom_log = document.getElementById("log");
function update_page() {
  var req = new XMLHttpRequest();
  req.addEventListener("load", function(e) {
    if(this.status == 200) {
      if(this.response.done) {
        window.location.reload();
      } else if(this.response.status == "queued") {
        preparing.style.display = "";
        running.style.display = "none";
        preparing.innerHTML = "<ul><li><strong>queued</strong></li><li>building</li><li>setting inputs</li></ul>";
      } else if(this.response.status == "building") {
        preparing.style.display = "";
        running.style.display = "none";
        preparing.innerHTML = "<ul><li>queued</li><li><strong>building</strong></li><li>setting inputs</li></ul>";
      } else if(this.response.status == "set_inputs") {
        preparing.style.display = "";
        running.style.display = "none";
        preparing.innerHTML = "<ul><li>queued</li><li>building</li><li><strong>setting inputs</strong></li></ul>";
      } else if(this.response.status == "running") {
        preparing.style.display = "none";
        running.style.display = "";
        if(this.response.log.length > 0) {
          log_lines += this.response.log.length;
          dom_log.textContent += this.response.log.join("\n") + "\n";
        }
      } else if(this.response.status == "store_outputs") {
        preparing.style.display = "none";
        running.style.display = "";
        finishing.style.display = "";
      }
    }
    setTimeout(update_page, 3000);
  });
  req.responseType = "json";
  req.open("GET", "{{ reverse_url('results', run.short_id) }}?log_from=" + log_lines);
  req.setRequestHeader("Accept", "application/json");
  req.send();
}

update_page();
</script>

{% endif %}

{% endblock content %}
